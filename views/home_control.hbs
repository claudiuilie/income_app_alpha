<div class="container">
    <header class="masthead bg-white text-white text-center" style="padding-top: 7em;padding-bottom: 2em;">
        <section class="page-section portfolio" id="portfolio">
            <div class="container">
                <div class="row">

                    <div class="col-md-6 col-lg-4">
                        <div class="portfolio-item mx-auto ">
                            <div class="card text-center text-primary ">
                                <div class="card-header p-0">

                                    {{#if schedule.veg_phase}}
                                    <span><i class="fas fa-seedling"></i></span>
                                    <span class="badge-primary badge">Phase: veg</span>
                                    <span><i class="fas fa-seedling"></i></span></br>
                                    {{/if}}
                                    {{#if schedule.fruit_phase}}
                                    <span><i class="fas fa-seedling"></i></span>
                                    <span class="badge-primary badge">Phase: fruit</span>
                                    <span><i class="fas fa-seedling"></i></span></br>
                                    {{/if}}
                                    <span class="badge-primary badge"> <i class="far fa-calendar-alt"></i> {{schedule.lamp_start}}:00 -
                                        {{schedule.lamp_stop}}:00</span>

                                </div>
                                <div class="card-body">
                                    <div class="m-0">
                                        <div class="container">
                                            <div class="GaugeMeter float-left" id="GaugeMeter_1"
                                                data-used="{{sensors.temperature}}" data-min="0" data-total="40"
                                                data-text="{{sensors.temperature}}&#8451" data-style="Arch"
                                                data-theme="Green-Gold-Red" data-label="Temperature"
                                                data-showvalue="10"></div>
                                            <div class="GaugeMeter float-right" id="GaugeMeter_2"
                                                data-used="{{sensors.humidity}}" data-min="0" data-total="100"
                                                data-text='{{sensors.humidity}}&#8274' data-style="Arch"
                                                data-theme="Green-Gold-Red" data-label="Humidity"></div>
                                            <div class="GaugeMeter float-right" id="GaugeMeter_3"
                                                data-used="{{sensors.soil_moisture}}" data-min="0" data-total="100"
                                                data-text='{{sensors.soil_moisture}}&#8274' data-style="Arch"
                                                data-theme="Green-Gold-Red" data-label="Soil Moisture"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="container p-2">
                                    <div class="container text-muted">
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="0"
                                                onclick="switchToggle(this)" value="">
                                            <label class="custom-control-label " for="0">
                                                 <span><i class="fas fa-lock" id="lock-badge"></i></span>
                                                <span></span></label>
                                        </div>
                                        <div class="custom-control custom-switch">

                                            <input type="checkbox" disabled class="custom-control-input" id="4"
                                                onclick="switchHandler(this)" {{#unless
                                                sensors.fan_off}}checked{{/unless}} value="">
                                            <label class="custom-control-label float-left" for="4">
                                                <i class="fas fa-fan"></i>
                                                <span>Fan</span></label>
                                        </div>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" disabled class="custom-control-input" id="3"
                                                onclick="switchHandler(this)" {{#unless
                                                sensors.pomp_off}}checked{{/unless}} value="">
                                            <label class="custom-control-label float-left" for="3">
                                                <i class="fas fa-shower"></i>
                                                <span>Water pomp</span></label>
                                        </div>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" disabled class="custom-control-input" id="5"
                                                onclick="switchHandler(this)" {{#unless
                                                sensors.veg_lamp_off}}checked{{/unless}} value="">
                                            <label class="custom-control-label float-left" for="5">
                                                <i class="far fa-lightbulb"></i>
                                                <span>LED Veg level</span></label>
                                        </div>

                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" disabled class="custom-control-input" id="6"
                                                onclick="switchHandler(this)" {{#unless
                                                sensors.fruit_lamp_off}}checked{{/unless}} value="">
                                            <label class="custom-control-label float-left" for="6">
                                                <i class="far fa-lightbulb"></i>
                                                <span>LED Fruit level</span></label>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 col-lg-4">
                        <div class="portfolio-item mx-auto">
                            <div class="card text-center text-primary">
                                <div class="card-header p-0">
                                    <span><i>Temperature</i>
                                    </span></br>
                                    <input type="text"
                                        class="border-0 bg-primary rounded histCalendar mb-2 text-center text-light "
                                        id="dailyTempHist" readonly="true" value="{{tempHistory.date}}"
                                        onclick="calendarHandler(this)" /></br>
                                    <span class="mb-2 p-1 rounded"
                                        style="border:1px solid red ;background-color:rgba(255,226,0,0.19);color:red;display: none;"></span>
                                </div>
                                <div class="card-body">
                                    <div class="m-0">
                                        <div class="container">

                                        </div>
                                    </div>
                                </div>
                                <div class="container p-2" style=" height:40vh; width:100%">
                                    <canvas id="temperatureHistoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="portfolio-item mx-auto">
                            <div class="card text-center text-primary">
                                <div class="card-header p-0">
                                    <span><i>Humidity</i></span></br>
                                    <input type="text"
                                        class="border-0 bg-primary rounded histCalendar mb-2 text-center text-light "
                                        id="dailyHumHist" readonly="true" value="{{tempHistory.date}}"
                                        onclick="calendarHandler(this)" /></br>
                                    <span class="p-1 rounded"
                                        style="border:1px solid red ;background-color:rgba(255,226,0,0.19);color:red;display: none;"></span>
                                </div>
                                <div class="card-body">
                                    <div class="m-0">
                                        <div class="container">

                                        </div>
                                    </div>
                                </div>
                                <div class="container p-2" style=" height:40vh; width:100%">
                                    <canvas id="humidityHistoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="portfolio-item mx-auto">
                            <div class="card text-center text-primary">
                                <div class="card-header p-0">
                                    <span><i>Soil moisture</i>
                                    </span></br>
                                    <input type="text"
                                        class="border-0 bg-primary rounded histCalendar mb-2 text-center text-light "
                                        id="dailySoilHist" readonly="true" value="{{tempHistory.date}}"
                                        onclick="calendarHandler(this)" /></br>
                                    <span class="mb-2 p-1 rounded"
                                        style="border:1px solid red ;background-color:rgba(255,226,0,0.19);color:red;display: none;"></span>
                                </div>
                                <div class="card-body">
                                    <div class="m-0">
                                        <div class="container">

                                        </div>
                                    </div>
                                </div>
                                <div class="container p-2" style=" height:40vh; width:100%">
                                    <canvas id="soilMoistureHistoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-4">
                        <div class="portfolio-item mx-auto ">
                            <div class="card text-center text-primary ">
                                <div class="card-header p-0">
                                    Relays
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-responsive table-striped">
                                        <thead>
                                            <tr>
                                                <th scope="col">Hour</th>
                                                <th scope="col">Fan</th>
                                                <th scope="col">Pomp</th>
                                                <th scope="col">VegLamp</th>
                                                <th scope="col">FruitLamp</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {{#each history}}

                                            <tr>
                                                <th scope="row">{{this.modified}}</th>
                                                <td>{{#if this.fan_off}} <i
                                                        class="fas fa-stop-circle text-danger"></i>{{else}} <i
                                                        class="fas fa-play-circle text-success"></i> {{/if}}</td>
                                                <td>{{#if this.pomp_off}} <i
                                                        class="fas fa-stop-circle text-danger"></i>{{else}} <i
                                                        class="fas fa-play-circle text-success"></i> {{/if}}</td>
                                                <td>{{#if this.veg_lamp_off}} <i
                                                        class="fas fa-stop-circle text-danger"></i>{{else}} <i
                                                        class="fas fa-play-circle text-success"></i> {{/if}}</td>
                                                <td>{{#if this.fruit_lamp_off}} <i
                                                        class="fas fa-stop-circle text-danger"></i>{{else}} <i
                                                        class="fas fa-play-circle text-success"></i> {{/if}}</td>
                                            </tr>
                                            {{/each}}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
        </section>
    </header>
</div>
<script src="/js/GaugeMeter.js"></script>
<script>
    $(document).ready(function () {
        $(".GaugeMeter").gaugeMeter();
    });

    let calendarId;

    function switchToggle(elem) {

        let lock = document.getElementById("lock-badge");
        if(elem.checked){
            lock.className = "fas fa-unlock"
        }else{
            lock.className = "fas fa-lock"
        }
        

        blockControl(elem);
        for (let i = 3; i <= 6; i++) {
            if (!$("#" + i)[0].disabled) {
                document.getElementById(i).setAttribute("disabled", "true");
            } else {
                document.getElementById(i).removeAttribute("disabled");
                document.getElementById(i).focus();
            }
        }
        unblockControl(elem);
    }
    function switchHandler(elem) {

        blockControl(elem);

        $.ajax({
            method: "POST",
            url: "/control",
            data: { "relayId": elem.id, "status": elem.checked, "switch": elem.value }
        }).done(function () {
            unblockControl(elem)
        })
    }

    function updateHistoryChart(chart, dataset) {
        chart.data.labels = dataset.history.sensorLabels

        if (dataset.temp) {
            chart.data.datasets[0].data = dataset.history.tempData
        }
        else if (dataset.hum) {
            chart.data.datasets[0].data = dataset.history.humidityData
        }
        else if (dataset.soil) {
            chart.data.datasets[0].data = dataset.history.soilMoistureData
        }
        chart.update();
    }

    function calendarHandler(elem) {
        calendarId = elem
    }

    $(function () {
        $('.histCalendar').daterangepicker({
            singleDatePicker: true,
            showDropdowns: true,
            minYear: 2019,
            maxYear: parseInt(moment().format('YYYY'), 10),
            opens: "center"
        }, function (start, end, label) {


            let date = new Date(start._d)
            let filteredTime = `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`;

            blockControl(calendarId);

            $.ajax({
                method: "POST",
                url: "/control/history",
                data: { "date": filteredTime, "calendarId": calendarId.id }
            }).done(function (newChart) {


                if (newChart.found) {

                    if (newChart.calendar == "dailyTempHist") {
                        newChart["temp"] = true;
                        updateHistoryChart(monthlyTempChart, newChart)
                    }
                    else if (newChart.calendar == "dailyHumHist") {
                        newChart["hum"] = true;
                        updateHistoryChart(monthlyHumChart, newChart)
                    }
                    else if (newChart.calendar == "dailySoilHist") {
                        newChart["soil"] = true;
                        updateHistoryChart(monthlySoilChart, newChart)
                    }
                } else {

                    $($(`#${newChart.calendar}`).parent().children()[4]).html(newChart.message);
                    $($(`#${newChart.calendar}`).parent().children()[4]).show();

                    setTimeout(() => {
                        $($(`#${newChart.calendar}`).parent().children()[4]).hide('slow');
                    }, 1500)
                }
                unblockControl(calendarId)
            })
        });
    });
</script>
<script src="/js/chart.js"></script>
<script>

    var ctxTempGraph = document.getElementById('temperatureHistoryChart');
    var monthlyTempChart = new Chart(ctxTempGraph, {
        type: 'bar',
        data: {
            labels: "{{tempHistory.sensorLabels}}".split(","),
            datasets: [{
                label: "Temperature",
                data: [{{ tempHistory.tempData }}],
            backgroundColor: 'rgba(255,226,0,0.19)',
            borderColor: 'rgb(255,238,0)',
            borderWidth: 1
        }]
    },
        options: {
        maintainAspectRatio: false,
        scales: {
            yAxes: [{
                offset: true,
                ticks: {
                    beginAtZero: true,
                    minRotation: 0,
                    maxRotation: 50,
                    mirror: false,
                    padding: 0,
                    reverse: false,
                    display: true,
                    autoSkip: false,
                    autoSkipPadding: 0,
                    labelOffset: 0
                },
                gridLines: {
                    display: false
                }
            }],
            xAxes: [{
                gridLines: {
                    display: false
                }
            }]
        }
    }
    });

    var ctxHumGraph = document.getElementById('humidityHistoryChart');
    var monthlyHumChart = new Chart(ctxHumGraph, {
        type: 'bar',
        data: {
            labels: "{{tempHistory.sensorLabels}}".split(","),
            datasets: [{
                label: "Himidity",
                data: [{{ tempHistory.humidityData }}],
            backgroundColor: 'rgba(0,188,0,0.19)',
            borderColor: 'rgb(0,188,0)',
            borderWidth: 1
        }]
    },
        options: {
        maintainAspectRatio: false,
        scales: {
            yAxes: [{
                offset: true,
                ticks: {
                    beginAtZero: true,
                    minRotation: 0,
                    maxRotation: 50,
                    mirror: false,
                    padding: 0,
                    reverse: false,
                    display: true,
                    autoSkip: false,
                    autoSkipPadding: 0,
                    labelOffset: 0
                },
                gridLines: {
                    display: false
                }
            }],
            xAxes: [{
                gridLines: {
                    display: false
                }
            }]
        }
    }
    });

    var ctxTempGraph = document.getElementById('soilMoistureHistoryChart');
    var monthlySoilChart = new Chart(ctxTempGraph, {
        type: 'bar',
        data: {
            labels: "{{tempHistory.sensorLabels}}".split(","),
            datasets: [{
                label: "Soil Moisture",
                data: [{{ tempHistory.soilMoistureData }}],
            backgroundColor: 'rgba(70, 248, 252,0.19)',
            borderColor: 'rgb(70, 248, 252)',
            borderWidth: 1
        }]
    },
        options: {
        maintainAspectRatio: false,
        scales: {
            yAxes: [{
                offset: true,
                ticks: {
                    beginAtZero: true,
                    minRotation: 0,
                    maxRotation: 50,
                    mirror: false,
                    padding: 0,
                    reverse: false,
                    display: true,
                    autoSkip: false,
                    autoSkipPadding: 0,
                    labelOffset: 0
                },
                gridLines: {
                    display: false
                }
            }],
            xAxes: [{
                gridLines: {
                    display: false
                }
            }]
        }
    }
    });
</script>